{% extends "base.html" %}
{% block content %}
<div class="form-container">
    <h2>Book a Slot</h2>
    <form method="POST">
        <small>
            {% if sale_days and all_sale_dates %}
            <i>Only the following dates are bookable:</i>
            {% for sd in sale_days %}
            {{ sd.start_date.strftime('%d %b %Y') }} to {{ sd.end_date.strftime('%d %b %Y') }}
            {% if not loop.last %}, {% endif %}
            {% endfor %}
            {% else %}
            You can book any upcoming date.
            {% endif %}
        </small>
        <p><label>Date:</label></p>
        <input type="text" id="sale-date-picker" name="date" required placeholder="Select date">


        <label>Time Slot:</label>
        <select name="slot_range" required>
            <option value="9-5">9 AM - 5 PM</option>
            <option value="10-6">10 AM - 6 PM</option>
            <option value="11-7">11 AM - 7 PM</option>
            <option value="12-8">12 PM - 8 PM</option>
        </select>

        <label>Branch:</label>
        <select name="branch" required>
            {% for b in branches %}
            <option value="{{ b.name }}">{{ b.name }}</option>
            {% endfor %}
        </select>

        <label>Section:</label>
        <select name="section" required>
            {% for s in sections %}
            <option value="{{ s.name }}">{{ s.name }}</option>
            {% endfor %}
        </select>

        <input type="submit" value="Book Slot">
    </form>
</div>

<hr style="margin: 3rem 0;">

<div class="form-container">
    <h2>All Booking Slots</h2>
    <ul style="list-style-type: none; padding: 0;">
        {% for slot in slots %}
        {% set booking = slot.bookings[0] if slot.bookings|length > 0 else None %}
        <li class="slot-item
                {% if booking %}
                    {% if booking.user_id == current_user_id %}
                        my-booking
                    {% else %}
                        other-booking
                    {% endif %}
                {% else %}
                    available
                {% endif %}">
            {{ slot.date }} |
            {{ slot.start_time.strftime("%I:%M %p") }} - {{ slot.end_time.strftime("%I:%M %p") }} |
            {{ slot.branch.name }} | {{ slot.section.name }}

            {% if booking %}
            {% if booking.user_id == current_user_id %}
            <b>âœ” Booked by you</b>
            {% else %}
            <b>ðŸ”’ Booked</b>
            {% endif %}
            {% else %}
            <b>âœ… Available</b>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</div>

<!-- Add flatpickr assets just before your closing </body> or at the end of this file -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    {% if sale_days and all_sale_dates %}
    var saleDates = [
        {% for date_str in all_sale_dates %}
    "{{ date_str }}"{% if not loop.last %}, {% endif %}
    {% endfor %}
        ];
    flatpickr("#sale-date-picker", {
        dateFormat: "Y-m-d",
        enable: saleDates,
    });
    {% else %}
    flatpickr("#sale-date-picker", {
        dateFormat: "Y-m-d",
        minDate: "{{ today_str }}"
    });
    {% endif %}
</script>

{% endblock %}